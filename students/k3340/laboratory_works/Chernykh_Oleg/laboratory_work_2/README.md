# Лабораторная работа №2

## Реализованный функционал

### 1. Регистрация новых пользователей

Реализована система регистрации пользователей через форму `UserRegistrationForm`, которая расширяет стандартную форму Django `UserCreationForm`. Форма включает следующие поля:
- Имя пользователя (username)
- Имя (first_name)
- Фамилия (last_name)
- Email
- Пароль и подтверждение пароля

После успешной регистрации пользователь автоматически авторизуется в системе.

**Реализация:**
- Представление: `register()` в `views.py`
- Форма: `UserRegistrationForm` в `forms.py`
- Шаблон: `templates/tours_app/register.html`
- URL: `/register/`

### 2. Просмотр и резервирование туров

#### Просмотр списка туров
Реализован список туров с использованием класс-представления `TourListView`, который наследуется от `ListView`. Список поддерживает:
- Пагинацию (5 туров на страницу)
- Поиск по названию, турагенству, описанию и стране
- Отображение карточек туров с основной информацией

#### Детальный просмотр тура
На странице детального просмотра отображается:
- Полная информация о туре (название, турагенство, описание, период проведения, условия оплаты, страна, цена)
- Список отзывов к туру (последние 10)
- Информация о резервировании пользователя (если он авторизован)
- Кнопка для создания резервирования (для авторизованных пользователей)

#### Резервирование туров
Пользователи могут:
- Создавать резервирования туров
- Просматривать список своих резервирований
- Удалять свои резервирования
- Видеть статус подтверждения резервирования

**Реализация:**
- Представления: `TourListView`, `TourDetailView`, `create_reservation()`, `my_reservations()`, `delete_reservation()`
- Форма: `ReservationForm` в `forms.py`
- Шаблоны: `tour_list.html`, `tour_detail.html`, `reservation_create.html`, `my_reservations.html`, `reservation_delete.html`
- URL: `/`, `/tour/<int:pk>/`, `/tour/<int:tour_id>/reserve/`, `/my-reservations/`, `/reservation/<int:reservation_id>/delete/`

**Особенности:**
- Резервирование доступно только авторизованным пользователям (декоратор `@login_required`)
- Пользователь может удалять только свои резервирования (проверка в `delete_reservation()`)
- Статус резервирования (`confirmed`) устанавливается администратором через Django-admin

### 3. Написание отзывов к турам

Реализована система отзывов с сохранением следующей информации:
- Дата тура (`tour_date`)
- Текст комментария (`text`)
- Рейтинг от 1 до 10 (`rating`) с валидацией через `MinValueValidator` и `MaxValueValidator`
- Информация о комментаторе (связь с моделью `User`)
- Дата создания отзыва (автоматически устанавливается при создании)

**Реализация:**
- Модель: `Review` в `models.py`
- Представление: `create_review()` в `views.py`
- Форма: `ReviewForm` в `forms.py`
- Шаблон: `review_create.html`
- URL: `/tour/<int:tour_id>/review/`

**Особенности:**
- Отзывы отображаются на странице детального просмотра тура
- Пользователь может оставить только один отзыв к каждому туру (проверка наличия `user_review` в контексте)
- Отзывы упорядочены по дате создания (от новых к старым)

### 4. Подтверждение резервирований администратором

Администратор может подтверждать резервирования через Django-admin панель. В админ-панели для модели `Reservation` реализовано:
- Отображение списка резервирований с информацией о пользователе, туре, дате резервирования и статусе
- Возможность редактирования статуса подтверждения прямо из списка (`list_editable = ('confirmed',)`)
- Фильтрация по статусу подтверждения и дате резервирования
- Поиск по имени пользователя и названию тура
- Иерархия по дате резервирования

**Реализация:**
- Класс `ReservationAdmin` в `admin.py`

### 5. Таблица проданных туров по странам

Реализована таблица, отображающая статистику проданных туров по странам на клиентской части (не в админ-панели). Таблица доступна только администраторам и показывает:
- Страну
- Количество проданных туров (только подтверждённые резервирования)
- Общую выручку по стране

**Реализация:**
- Представление: `sold_tours_by_country()` в `views.py` с декоратором `@staff_member_required`
- Использование агрегации Django ORM: `values()`, `annotate()`, `Count()`, `Sum()`
- Шаблон: `sold_tours_by_country.html`
- URL: `/admin/sold-tours/`

**Особенности:**
- Доступ только для администраторов (проверка через `@staff_member_required` и `user.is_staff`)
- Данные упорядочены по количеству проданных туров (от большего к меньшему)
- Учитываются только подтверждённые резервирования (`confirmed=True`)

## Модели данных

### Tour (Тур)
Модель хранит информацию о туре:
- `title` - название тура (CharField, max_length=200)
- `agency` - турагенство (CharField, max_length=200)
- `description` - описание тура (TextField)
- `start_date` - дата начала тура (DateField)
- `end_date` - дата окончания тура (DateField)
- `payment_terms` - условия оплаты (TextField)
- `country` - страна (CharField, max_length=100)
- `price` - цена (DecimalField, max_digits=10, decimal_places=2)

### Reservation (Резервирование)
Модель для хранения резервирований туров:
- `user` - пользователь (ForeignKey к User)
- `tour` - тур (ForeignKey к Tour)
- `reservation_date` - дата резервирования (DateTimeField, auto_now_add=True)
- `confirmed` - статус подтверждения (BooleanField, default=False)

### Review (Отзыв)
Модель для хранения отзывов к турам:
- `user` - пользователь (ForeignKey к User)
- `tour` - тур (ForeignKey к Tour, related_name='reviews')
- `tour_date` - дата тура (DateField)
- `text` - текст отзыва (TextField)
- `rating` - рейтинг от 1 до 10 (IntegerField с валидаторами)
- `created_at` - дата создания (DateTimeField, auto_now_add=True)

## Представления (Views)

### Функциональные представления

1. **`register(request)`** - регистрация пользователя
   - Обрабатывает GET и POST запросы
   - Автоматически авторизует пользователя после регистрации

2. **`create_reservation(request, tour_id)`** - создание резервирования
   - Декоратор `@login_required`
   - Связывает резервирование с текущим пользователем и выбранным туром

3. **`my_reservations(request)`** - список резервирований пользователя
   - Декоратор `@login_required`

4. **`edit_reservation(request, reservation_id)`** - редактирование резервирования
   - Показывает сообщение о необходимости удалить и создать новое резервирование

5. **`delete_reservation(request, reservation_id)`** - удаление резервирования
   - Декоратор `@login_required`
   - Проверка, что пользователь удаляет только своё резервирование

6. **`create_review(request, tour_id)`** - создание отзыва
   - Декоратор `@login_required`
   - Связывает отзыв с текущим пользователем и выбранным туром

7. **`admin_dashboard(request)`** - панель администратора
   - Декоратор `@login_required` с проверкой `is_staff`
   - Отображает статистику: общее количество туров, резервирований, подтверждённых и ожидающих резервирований

### Класс-представления

1. **`TourListView(ListView)`** - список туров
   - Наследуется от `ListView`
   - Пагинация: 5 туров на страницу (`paginate_by = 5`)
   - Поиск через переопределение `get_queryset()` с использованием `Q` объектов
   - Поиск по полям: `title`, `agency`, `description`, `country`

2. **`TourDetailView(DetailView)`** - детальный просмотр тура
   - Наследуется от `DetailView`
   - Добавляет в контекст список отзывов, резервирование и отзыв текущего пользователя (если авторизован)

## Формы

### UserRegistrationForm
Расширяет `UserCreationForm` для добавления полей:
- Email (обязательное поле)
- Имя (first_name)
- Фамилия (last_name)
- Стилизация полей через атрибут `class='form-control'` для Bootstrap

### ReservationForm
Простая форма на основе модели `Reservation`:
- Скрытое поле `tour` (HiddenInput)
- Тур передаётся через параметр URL

### ReviewForm
Форма для создания отзыва на основе модели `Review`:
- Поля: `tour_date` (DateInput), `text` (Textarea), `rating` (NumberInput с min=1, max=10)

## Админ-панель Django

### TourAdmin
Настройки для модели `Tour`:
- Отображение: название, турагенство, страна, даты начала и окончания, цена
- Фильтры: страна, турагенство, дата начала
- Поиск: название, турагенство, описание, страна
- Иерархия по дате начала

### ReservationAdmin
Настройки для модели `Reservation`:
- Отображение: пользователь, тур, дата резервирования, статус подтверждения
- Редактирование статуса из списка (`list_editable`)
- Фильтры: статус подтверждения, дата резервирования
- Поиск: имя пользователя, название тура
- Иерархия по дате резервирования

### ReviewAdmin
Настройки для модели `Review`:
- Отображение: пользователь, тур, рейтинг, дата тура, дата создания
- Фильтры: рейтинг, дата создания, дата тура
- Поиск: имя пользователя, название тура, текст отзыва
- Иерархия по дате создания

## Шаблоны (HTML)

### Базовый шаблон (base.html)
Содержит общую структуру всех страниц:
- Навигационное меню с Bootstrap (`navbar`)
- Условное отображение пунктов меню в зависимости от статуса пользователя:
  - Для всех: "Туры"
  - Для авторизованных: "Мои резервирования"
  - Для администраторов: "Панель администратора", "Проданные туры"
  - Для неавторизованных: "Регистрация", "Войти"
  - Для авторизованных: приветствие и кнопка "Выйти"
- Блоки `{% block title %}` и `{% block content %}` для наследования

### tour_list.html
Список туров с:
- Формой поиска с сохранением поискового запроса
- Отображением туров в виде карточек (Bootstrap cards)
- Пагинацией с сохранением поискового запроса в URL параметрах
- Обработкой случая отсутствия туров

### tour_detail.html
Детальная страница тура с:
- Двухколоночной структурой (основная информация и боковая панель)
- Отображением полной информации о туре
- Списком отзывов с информацией о пользователе, рейтинге, дате тура
- Условным отображением кнопки резервирования или информации о существующем резервировании
- Условным отображением кнопки добавления отзыва (если пользователь ещё не оставил отзыв)

### my_reservations.html
Таблица резервирований пользователя с:
- Информацией о туре, стране, периоде, цене, дате резервирования, статусе
- Кнопкой удаления с подтверждением через JavaScript
- Обработкой случая отсутствия резервирований

### admin_dashboard.html
Панель администратора с:
- Статистическими карточками (Bootstrap cards) с общей информацией
- Ссылками на админ-панель Django и страницу проданных туров
- Проверкой прав доступа (`user.is_staff`)

### sold_tours_by_country.html
Таблица проданных туров с:
- Заголовками: Страна, Количество проданных туров, Общая выручка
- Обработкой случая отсутствия данных
- Проверкой прав доступа (`user.is_staff`)

## Маршрутизация (URLs)

### Основной файл urls.py (tour_agency_project/urls.py)
- `/admin/` - админ-панель Django
- `/` - включает маршруты приложения `tours_app`

### Маршруты приложения (tours_app/urls.py)
- `/` - список туров (`tour_list`)
- `/tour/<int:pk>/` - детальный просмотр тура (`tour_detail`)
- `/register/` - регистрация (`register`)
- `/tour/<int:tour_id>/reserve/` - создание резервирования (`create_reservation`)
- `/my-reservations/` - список резервирований пользователя (`my_reservations`)
- `/reservation/<int:reservation_id>/edit/` - редактирование резервирования (`edit_reservation`)
- `/reservation/<int:reservation_id>/delete/` - удаление резервирования (`delete_reservation`)
- `/tour/<int:tour_id>/review/` - создание отзыва (`create_review`)
- `/admin/dashboard/` - панель администратора (`admin_dashboard`)
- `/admin/sold-tours/` - проданные туры по странам (`sold_tours_by_country`)

## Разделение прав доступа

### Для неавторизованных пользователей
- Просмотр списка туров
- Просмотр детальной информации о туре
- Просмотр отзывов
- Поиск туров
- Регистрация и вход в систему

### Для авторизованных пользователей
- Все функции неавторизованных пользователей
- Создание резервирований туров
- Просмотр своих резервирований
- Удаление своих резервирований
- Добавление отзывов к турам

### Для администраторов (is_staff=True)
- Все функции обычных пользователей
- Доступ к панели администратора (`admin_dashboard`)
- Просмотр таблицы проданных туров по странам (`sold_tours_by_country`)
- Доступ к Django-admin панели для управления всеми объектами
- Подтверждение резервирований через админ-панель

**Реализация проверок:**
- Декораторы: `@login_required`, `@staff_member_required`
- Проверки в представлениях: `if not request.user.is_staff`
- Условные блоки в шаблонах: `{% if user.is_authenticated %}`, `{% if user.is_staff %}`

## Пагинация

Реализована пагинация для списка туров:
- Использование класс-представления `ListView` с параметром `paginate_by = 5`
- Отображение пагинации в шаблоне через `{% if is_paginated %}`
- Кнопки: "Первая", "Предыдущая", "Следующая", "Последняя"
- Отображение текущей страницы и общего количества страниц
- Сохранение поискового запроса в URL параметрах при переходе между страницами

**Реализация в шаблоне:**
- Использование `page_obj.has_previous`, `page_obj.has_next`
- Формирование URL с параметрами `?page=X&search=query`

## Поиск

Реализован поиск по турам с пагинацией:
- Поиск по полям: название (`title`), турагенство (`agency`), описание (`description`), страна (`country`)
- Использование `Q` объектов для сложных запросов с оператором `OR`
- Регистронезависимый поиск через `icontains`
- Сохранение поискового запроса в контексте и URL параметрах
- Отображение поискового запроса в поле ввода
- Сохранение поискового запроса при пагинации

**Реализация:**
- Переопределение метода `get_queryset()` в `TourListView`
- Форма поиска в шаблоне `tour_list.html`
- Передача параметра `search` через GET запрос

## Меню с Bootstrap

Реализовано навигационное меню с использованием Bootstrap 5.3:
- Адаптивное меню с кнопкой-переключателем для мобильных устройств (`navbar-toggler`)
- Условное отображение пунктов меню:
  - Общие пункты для всех пользователей
  - Дополнительные пункты для авторизованных пользователей
  - Специальные пункты для администраторов
- Отображение информации о текущем пользователе
- Ссылки на регистрацию/вход для неавторизованных пользователей
- Ссылка на выход для авторизованных пользователей

**Структура меню:**
- Логотип/название сайта (ссылка на главную)
- Основные пункты меню (слева)
- Пользовательские действия (справа)


## Заключение

Модель данных спроектирована с учётом удобства использования: используются связи ForeignKey для нормализации данных, добавлены метаданные для удобной работы в админ-панели, реализованы валидаторы для обеспечения целостности данных.
